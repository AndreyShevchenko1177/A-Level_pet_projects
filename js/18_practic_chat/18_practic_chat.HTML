<!DOCTYPE html>
<!-- saved from url=(0025)http://192.168.1.20:5000/ -->
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>18_practic_chat</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    </head>

    <body>
        <div id="formContainer"></div>

        <input type="text" id="nickId" />
        <input type="text" id="msgId" />
        <button id="sendId">Send msg</button>

        <div class="chat" id="chatId">sdfasfasfvasafvasfabvfasdfbasbfas</div>

        <script>
            jsonPost("http://students.a-level.com.ua:10012", {
                func: "addMessage",
                nick: "Sheva",
                message: "++Hi++",
            });

            function jsonPost(url, data) {
                return new Promise((resolve, reject) => {
                    var x = new XMLHttpRequest();
                    x.onerror = () => reject(new Error("jsonPost failed"));
                    //x.setRequestHeader('Content-Type', 'application/json');
                    x.open("POST", url, true);
                    x.send(JSON.stringify(data));

                    x.onreadystatechange = () => {
                        if (x.readyState == XMLHttpRequest.DONE && x.status == 200) {
                            resolve(JSON.parse(x.responseText));
                        } else if (x.status != 200) {
                            reject(new Error("status is not 200"));
                        }
                    };
                });
            }

            sendId.onclick = function () {
                jsonPost("http://students.a-level.com.ua:10012", {
                    func: "addMessage",
                    nick: nickId.value,
                    message: msgId.value,
                });
            };

            //

            //

            let msgHist = [];
            let startMsgId = 0;
            let data;

            setInterval(() => {
                let j = jsonPost("http://students.a-level.com.ua:10012", {
                    func: "getMessages",
                    messageId: startMsgId,
                }).then((x) => {
                    startMsgId = x.nextMessageId;
                    console.log(startMsgId);
                    shouMsg(x.data);
                });

                let shouMsg = function (msgArr) {
                    console.log(msgArr);
                    // msgArr.reverse();
                    msgArr.forEach((element) => {
                        let str = element.nick + ": " + element.message + "<br>";
                        chatId.insertAdjacentHTML("afterbegin", str);
                    });
                };
            }, 2000);
        </script>
    </body>
</html>
